<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Form Builder</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>

        body {
            padding: 160px !important;
        }

       .save-template {
            display: none !important;
        }

        div#render-container {
            width: 800px;
            margin: 0 auto;
            border: 1px solid #e1dfdf;
            padding: 2em;
        }

        button#copyHTMLBtn {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            background: #35363a;
            color: #ffffff;
            padding: 15px 24px;
            outline: none;
            border: 0;
            border-top-left-radius: 5px;
            border-top-right-radius: 5px;
            font-size: 20px;
            font-family: Helvetica;
        }

        .top_info {
            margin-bottom: 50px;
            border-bottom: 1px solid #e1dfdf;
            padding-bottom: 20px;
        }

        .form_preview_section {
            margin: 0 auto !important;
            width: 800px;
            border-bottom: 1px solid #e1dfdf;
            margin-bottom: 50px !important;
            padding-bottom: 15px;
            margin-top: 270px !important;
        }

        

        
    </style>
    
</head>
<body>
    <div class="top_info">
        <h1>Secure Forms Made Easy</h1>
        <p>Simply drag and drop an item from the right onto the form preview on the left.</p>
    </div>
    
    <div id="fb-editor"></div>
    <div class="form_preview_section">
        <h1>Here is your generated form.</h1>
        <p>Click the "add attachment to form" or "toggle mailbox form" buttons if needed and simply hit the Copy HTML button and add your finished secure form to content.</p>
    </div>
    <div id="render-container"></div>
    <button id="copyHTMLBtn" style="display:none;">Copy HTML</button>
    <textarea id="htmlOutput" style="display:none;"></textarea>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>
    <script src="https://formbuilder.online/assets/js/form-builder.min.js"></script>
    <script src="https://formbuilder.online/assets/js/form-render.min.js"></script>
    <script src="transform.js"></script>
    <script src="attachmentHandler.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        function mainScript() {
            jQuery(function($) {
                window.isMailboxForm = false;

                var options = {
                    dataType: 'json',
                    fields: [
                        {
                            label: "Email",
                            type: "text",
                            subtype: "email",
                            icon: "✉"
                        },
                        {
                            label: "Phone Number",
                            type: "text",
                            subtype: "tel",
                            icon: "☎"
                        },
                        {
                            label: "Member First Name",
                            type: "text",
                            name: "member_first_name",
                            placeholder: "Will be auto-filled with Member's First Name",
                            value: "|member.first_name|"
                        },
                        {
                            label: "Member Middle Name",
                            type: "text",
                            name: "member_middle_name",
                            placeholder: "Will be auto-filled with Member's Middle Name",
                            value: "|member.middle_name|"
                        },
                        {
                            label: "Member Last Name",
                            type: "text",
                            name: "member_last_name",
                            placeholder: "Will be auto-filled with Member's Last Name",
                            value: "|member.last_name|"
                        },
                        {
                            label: "Member ID",
                            type: "text",
                            name: "member_ID",
                            placeholder: "Will be auto-filled with Member's ID",
                            value: "|member.memberId|"
                        },
                        {
                            label: "Member Email",
                            type: "text",
                            subtype: "email",
                            name: "member_email",
                            placeholder: "Will be auto-filled with Member's Email",
                            value: "|member.email|"
                        },
                        {
                            label: "Member Birthdate",
                            type: "text",
                            name: "member_birthdate",
                            placeholder: "Will be auto-filled with Member's Birthdate",
                            value: "|member.birthdate|"
                        },
                        {
                            label: "Member Benefit Plan ID",
                            type: "text",
                            name: "member_benefit_plan_id",
                            placeholder: "Will be auto-filled with Member's Benefit Plan ID",
                            value: "|member.benefit_plan_id|"
                        },
                        {
                            label: "Member Benefit Plan Name",
                            type: "text",
                            name: "member_benefit_plan_name",
                            placeholder: "Will be auto-filled with Member's Benefit Plan Name",
                            value: "|member.benefit_plan_name|"
                        }
                    ],
                    typeUserAttrs: {
                        text: {
                            pattern: {
                                label: 'Pattern',
                                description: 'Enter a RegExp for validation'
                            }
                        }
                    },
                    actionButtons: [
                    {
                            id: 'toggleFormType',
                            className: 'btn btn-info',
                            label: window.isMailboxForm ? "Set as Normal Form" : "Toggle Mailbox Form",
                            type: 'button',
                            events: {
                                click: function() {
                                    console.log("toggleFormType button clicked. Previous state:", window.isMailboxForm);
                                    window.isMailboxForm = !window.isMailboxForm;
                                    console.log("New state:", window.isMailboxForm);
                                    
                                    // Check if the form is now set as a mailbox form
                                    if (window.isMailboxForm) {
                                        Swal.fire({
                                            title: 'Enter Mailbox ID',
                                            input: 'text',
                                            inputLabel: 'Mailbox ID',
                                            inputPlaceholder: 'Enter the Mailbox ID here',
                                            showCancelButton: true
                                        }).then((result) => {
                                            if (result.isConfirmed) {
                                                // Store the mailbox ID temporarily
                                                window.mailboxID = result.value;

                                                const renderedFormDiv = document.querySelector('.rendered-form');
                                                let mailboxInput = document.querySelector('input[name="sf:recipient_mailbox"]');
                                                
                                                if (!mailboxInput && renderedFormDiv) { 
                                                    console.log('Inserting new mailbox input');
                                                    mailboxInput = document.createElement('input');
                                                    mailboxInput.type = 'hidden';
                                                    mailboxInput.name = 'sf:recipient_mailbox';
                                                    renderedFormDiv.parentNode.insertBefore(mailboxInput, renderedFormDiv);
                                                }
                                                
                                                // If mailboxInput exists, update its value with the new mailbox ID
                                                if (mailboxInput) {
                                                    console.log('Updating mailbox input with new value:', window.mailboxID);
                                                    mailboxInput.value = window.mailboxID;
                                                }
                                            }
                                        });
                                    } else {
                                        // If it is a normal form, remove the hidden mailbox input if it exists
                                        let mailboxInput = document.querySelector('input[name="sf:recipient_mailbox"]');
                                        if (mailboxInput) {
                                            console.log('Removing mailbox input as it is a normal form');
                                            mailboxInput.remove();
                                        }
                                    }

                                    
                                    // Getting a reference to the button using its ID
                                    var toggleButton = document.querySelector("[id$='-toggleFormType-action']");
                                    toggleButton.innerHTML = window.isMailboxForm ? "Set as Normal Form" : "Toggle Mailbox Form";
                                }
                            }
                        },
                        {
                            id: 'toggleAttachmentBtn',
                            className: 'btn btn-warning',
                            label: 'Add Attachment to Form',
                            type: 'button',
                            events: {
                                click: function() {
                                    // Getting a reference to the button using its ID
                                    var attachmentButton = document.querySelector("[id$='-toggleAttachmentBtn-action']");

                                    
                                    toggleAttachmentStatus(attachmentButton);
                                }
                            }
                        },
                        {
                            "id": "saveTemplate",
                            "className": "btn btn-success special",
                            "label": "Save Template",
                            "type": "button",
                            "events": {
                                "click": function() {
                                    if (window.isMailboxForm) {
                                        console.log('Mailbox form detected');
                                        
                                        let mailboxInput = document.querySelector('input[name="sf:recipient_mailbox"]');
                                        console.log('Mailbox Input:', mailboxInput);

                                        if (mailboxInput) {
                                            if (window.mailboxID) {
                                                console.log('Updating mailbox input with stored value:', window.mailboxID);
                                                mailboxInput.value = window.mailboxID;
                                                
                                            } else if (!/^\d+$/.test(mailboxInput.value)) {
                                                console.log('Prompting for new mailbox ID');
                                                Swal.fire({
                                                    title: 'Enter Mailbox ID',
                                                    input: 'text',
                                                    inputLabel: 'Mailbox ID',
                                                    inputPlaceholder: 'Enter the Mailbox ID here',
                                                    showCancelButton: true
                                                }).then((result) => {
                                                    if (result.isConfirmed) {
                                                        // Reselect mailboxInput from the DOM
                                                        mailboxInput = document.querySelector('input[name="sf:recipient_mailbox"]');
                                                        // Now update its value
                                                        mailboxInput.value = result.value;
                                                        console.log('Updated mailboxInput:', mailboxInput, 'with value:', result.value);
                                                    } else {
                                                        return;
                                                    }
                                                });
                                            }
                                        } else {
                                            console.log('Mailbox input not found. Ensure it is created when toggling to mailbox form.');
                                        }
                                    }

                                    var formData = formBuilder.actions.getData('json', true);

                                    if (formData) {
                                        $('#render-container').formRender({
                                            formData: formData
                                        });

                                        const html = $('#render-container').formRender('html');
                                        const transformedHTML = transformHTML(html);
                                        const wrappedContent = wrapContentWithFormTemplate(transformedHTML);
                                        $('#render-container').html(wrappedContent);
                                    }

                                    $('#copyHTMLBtn').show();
                                    var targetElement = document.querySelector('.form_preview_section');
                                    if (targetElement) {
                                        targetElement.scrollIntoView({
                                            behavior: 'smooth',
                                            block: 'start'
                                        });
                                    }
                                }
                            }
                        }

                    ]
                };

                var formBuilder = $(document.getElementById('fb-editor')).formBuilder(options);

                $('#copyHTMLBtn').click(function() {
                    var formData = formBuilder.actions.getData('json', true);

                    if (formData) {
                        $('#render-container').formRender({
                            formData: formData
                        });

                        const html = $('#render-container').formRender('html');
                        const transformedHTML = transformHTML(html);
                        const wrappedContent = wrapContentWithFormTemplate(transformedHTML);
                        $('#render-container').html(wrappedContent);
                    } 

                    var htmlContent = $('#render-container').html();

                    navigator.clipboard.writeText(htmlContent).then(function() {
                        alert('HTML copied to clipboard!');
                    }).catch(function(err) {
                        alert('Failed to copy text: ', err);
                    });

                    $('#htmlOutput').hide();
                });

                function wrapContentWithFormTemplate(content) {
                    return addAttachmentToForm(content);
                }




                // New Sweet Alert code
                Swal.fire({
                    title: 'Enter Form Name',
                    input: 'text',
                    inputLabel: 'Form Name',
                    inputPlaceholder: 'Enter the Form Name',
                    showCancelButton: false, // Set to true if you want to allow cancel
                }).then((result) => {
                    if (result.isConfirmed) {
                        updateFormName(result.value);
                    }
                });
            });
        }


        function updateFormName(formName) {
            // Update the hidden input value
            const hiddenInput = document.querySelector('input[name="sf:form_name"]');
            if (hiddenInput) {
                hiddenInput.value = formName;
            }

            // Update the form name attribute
            const formElement = document.querySelector('form[action="/app/secureForms/submitFormAsMessage"]');
            if (formElement) {
                formElement.setAttribute('name', formName);
            }
        }

        document.addEventListener('DOMContentLoaded', mainScript);
    </script>
</body>
</html>
